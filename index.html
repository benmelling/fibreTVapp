<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>StreamTV OS V127</title>
<meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" content="#000000">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<style>
:root { --bg: #000; --surf: rgba(20,20,20,0.95); --rad: 50px; --card: 12px; --gutter: 50px; 
--live: #0047AB; --tv: #D35400; --mov: #27AE60; --yt: #E50914; --mus: #C2185B; --rec: #F1C40F; }
* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body { margin: 0; background: var(--bg); color: #fff; font-family: 'Outfit', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
#bg-vid { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; opacity: 1; filter: blur(30px) brightness(0.4); transition: 0.5s; pointer-events: none; }
body.fs #bg-vid { filter: blur(0); z-index: 0; pointer-events: auto; }
body.fs .top-nav, body.fs .main, body.fs .info { display: none !important; }

/* Navigation */
.top-nav { position: fixed; top: 30px; left: var(--gutter); z-index: 6000; display: flex; }
.nav-cap { background: var(--surf); backdrop-filter: blur(30px); border-radius: var(--rad); padding: 5px; display: flex; gap: 5px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: border-color 0.3s; }
.n-item { height: 44px; padding: 0 24px; border-radius: var(--rad); color: #888; font-weight: 700; cursor: pointer; display: flex; align-items: center; transition: 0.2s; white-space: nowrap; }
.n-item:hover, .n-item.foc { color: #fff; background: rgba(255,255,255,0.1); }
/* Active Colors */
.nav-cap.live { border-color: var(--live); } .nav-cap.live .n-item.act { background: var(--live); color: #fff; }
.nav-cap.tv { border-color: var(--tv); } .nav-cap.tv .n-item.act { background: var(--tv); color: #fff; }
.nav-cap.mov { border-color: var(--mov); } .nav-cap.mov .n-item.act { background: var(--mov); color: #fff; }
.nav-cap.yt { border-color: var(--yt); } .nav-cap.yt .n-item.act { background: var(--yt); color: #fff; }
.nav-cap.mus { border-color: var(--mus); } .nav-cap.mus .n-item.act { background: var(--mus); color: #fff; }
.nav-cap.rec { border-color: var(--rec); } .nav-cap.rec .n-item.act { background: var(--rec); color: #000; }
.n-item.act { background: #fff; color: #000; box-shadow: 0 2px 15px rgba(255,255,255,0.25); }

.n-item.icon { padding: 0; width: 44px; justify-content: center; }
.search-box { display:flex; align-items:center; width:350px; padding-left:10px; }
.search-inp { background:transparent; border:none; color:#fff; font-family:'Outfit'; font-size:1.1rem; flex:1; font-weight: 600; }

.info { position: fixed; top: 30px; right: 40px; background: var(--surf); border-radius: var(--rad); height: 54px; padding: 0 25px; display: flex; align-items: center; z-index: 6000; border: 1px solid rgba(255,255,255,0.1); }
.clock { font-size: 1.1rem; font-weight: 800; }

/* Main Layout */
.main { flex: 1; overflow-y: auto; overflow-x: hidden; padding-top: 130px; padding-bottom: 50px; }
.bg-live { background: linear-gradient(to bottom, rgba(0,0,0,0.5), #001a40) !important; }
.bg-tv { background: linear-gradient(to bottom, rgba(0,0,0,0.5), #401a00) !important; }
.bg-mov { background: linear-gradient(to bottom, rgba(0,0,0,0.5), #00331a) !important; }
.bg-yt { background: linear-gradient(to bottom, rgba(0,0,0,0.5), #400000) !important; }
.bg-mus { background: linear-gradient(to bottom, rgba(0,0,0,0.5), #400033) !important; }

.tab { display: none; padding: 0 var(--gutter) 50px; }
.tab.act { display: block; animation: fade 0.3s; }
@keyframes fade { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
#t-live.act { padding: 0; overflow: hidden; height: 100%; display: flex; }

/* Preview Pane (Top Flush) */
.split { display: flex; height: 100%; }
.side { width: 260px; padding: 130px 0 0 var(--gutter); display: flex; flex-direction: column; }
.v-menu { background: rgba(25,25,25,0.95); border-radius: 25px; padding: 20px; height: calc(100vh - 160px); overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); }
.v-btn { padding: 15px; border-radius: 12px; color: #999; font-weight: 600; cursor: pointer; margin-bottom: 5px; }
.v-btn.act { background: #fff; color: #000; }

.linear { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
/* FIX: Preview Flush Top */
.linear-header { 
    flex: 0 0 auto; width: 100%; height: 40vh; min-height: 300px;
    margin: 0; background: #000; position: relative; 
    display: flex; z-index: 0; padding-top: 100px; margin-top: -130px;
}
.lh-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; filter: blur(40px) brightness(0.4); z-index: 0; }
.head-con { position: relative; z-index: 1; width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 20px 40px; gap: 40px; }
.lh-box { width: 180px; aspect-ratio: 1/1; background: #111; border-radius: 16px; display: grid; place-items: center; box-shadow: 0 20px 50px rgba(0,0,0,0.6); flex-shrink: 0; }
.lh-img { width: 80%; height: 80%; object-fit: contain; }
.lh-info { flex: 1; }
.lh-tit { font-size: 2.5rem; font-weight: 800; margin-bottom: 10px; line-height: 1.1; }
.lh-meta { font-size: 1rem; color: #ccc; margin-bottom: 10px; font-weight: 700; }
.lh-desc { font-size: 1rem; color: #aaa; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
.prev-vid { width: 450px; aspect-ratio: 16/9; background: #000; border-radius: 16px; overflow: hidden; border: 1px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
.prev-vid video { width: 100%; height: 100%; object-fit: cover; }

/* EPG (Sky Style) */
.epg-head { height: 40px; background: #080808; display: flex; border-bottom: 1px solid #222; position: relative; z-index: 10; }
.epg-h-l { width: 400px; flex-shrink: 0; background: #080808; border-right: 1px solid #222; }
.epg-h-t { flex: 1; display: flex; position: relative; overflow: hidden; align-items: center; }
.tm-mk { position: absolute; font-size: 0.8rem; color: #888; border-left: 1px solid #333; padding-left: 8px; height: 20px; line-height: 20px; font-weight: 700; }

.epg-scroll { flex: 1; overflow-y: auto; background: #050505; }
.erow { display: flex; align-items: center; height: 80px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: background 0.1s; }
.erow:hover, .erow:focus { background: #222; outline: none; }
.ecol { width: 400px; display: flex; align-items: center; padding: 0 15px; border-right: 1px solid rgba(255,255,255,0.1); height: 100%; flex-shrink: 0; background: #0f0f0f; z-index: 10; position:sticky; left:0; }
.enum { width: 70px; color: #888; font-weight: 800; font-size: 1.2rem; display:flex; justify-content:center; }
.elog { width: 90px; justify-content: center; display:flex; margin-right: 15px; } 
.elog img { max-height: 55px; max-width: 100%; object-fit: contain; }
.ename { width: 200px; font-weight: 700; font-size: 1.1rem; color: #eee; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

.etline { flex: 1; display: flex; align-items: center; overflow-x: auto; position: relative; scrollbar-width: none; }
.eblock { height: 80%; background: rgba(255,255,255,0.1); margin-right: 2px; border-radius: 4px; padding: 0 12px; display: flex; flex-direction: column; justify-content: center; position: relative; flex-shrink: 0; overflow: hidden; }
.eblock:hover { background: rgba(255,255,255,0.25); border-color: white; }
.prog-t { font-weight: 700; font-size: 0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.prog-d { font-size: 0.75rem; color: #888; }
.now-line { position: absolute; top: 0; bottom: 0; width: 2px; background: #5DADE2; z-index: 20; pointer-events: none; box-shadow: 0 0 8px #5DADE2; }

/* Cards */
.row { margin-bottom: 30px; }
.row-h { font-size: 1.3rem; font-weight: 800; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px; }
.scroll { display: flex; gap: 20px; overflow-x: auto; padding: 5px 0; scroll-behavior: smooth; }
.scroll::-webkit-scrollbar { display: none; }
.cd { flex: 0 0 auto; background: #222; border-radius: 12px; position: relative; cursor: pointer; transition: 0.2s; overflow: hidden; border: 2px solid transparent; }
.cd:hover, .cd:focus { transform: scale(1.05); z-index: 5; border-color: white; }
.c-post { width: 160px; height: 240px; background-size: cover; }
.c-sq { width: 160px; height: 160px; background-color: #1a1a1a; display: flex; align-items: center; justify-content: center; } 
.c-rec { width: 280px; height: 158px; background-size: cover; }
.rec-ov { position: absolute; bottom: 8px; right: 8px; width: 40px; height: 40px; background: rgba(0,0,0,0.8); border-radius: 6px; padding: 4px; object-fit: contain; }
.rec-ico { position: absolute; top: 8px; left: 8px; width: 30px; height: 30px; background: rgba(0,0,0,0.8); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 0.8rem; }
.rd-det { height: 0; overflow: hidden; transition: 0.2s; opacity: 0; padding-left: 5px; margin-top: 5px; }
.rd-det.vis { height: auto; opacity: 1; margin-bottom: 20px; }
.rd-t { font-size: 1.5rem; font-weight: 800; }
.rd-d { font-size: 1rem; color: #aaa; margin-top: 5px; }
.c-ov { position: absolute; bottom: 0; width: 100%; padding: 10px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); opacity: 0; } /* Only show on hover? User said below row */

/* Search Grid */
.s-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 20px; }

/* Settings */
.set-g { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; max-width: 800px; }
.set-c { background: #222; padding: 25px; border-radius: 16px; }
.sw { position: relative; display: inline-block; width: 50px; height: 28px; float:right; }
.sw input { opacity: 0; width: 0; height: 0; }
.sl { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 34px; }
.sl:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .sl { background-color: #fff; }
input:checked + .sl:before { transform: translateX(22px); background-color: #000; }
.btn { width: 100%; padding: 15px; background: var(--live); color: white; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; margin-top: 10px; }

/* Popups */
#pop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 6000; overflow-y: auto; }
.p-hero { height: 65vh; background-size: cover; position: relative; }
.p-grad { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, #000 10%, transparent 100%); }
.p-body { display: flex; gap: 40px; padding: 0 var(--gutter); margin-top: -120px; position: relative; align-items: flex-end; }
.p-post { width: 220px; aspect-ratio: 2/3; background: #222; border-radius: 12px; background-size: cover; box-shadow: 0 20px 60px #000; }
.p-post.sq { aspect-ratio: 1/1; display:flex; align-items:center; justify-content:center; }
.p-info { flex: 1; padding-bottom: 50px; }
.p-btn { background: rgba(255,255,255,0.15); border: none; color: #fff; padding: 15px 30px; border-radius: 10px; font-weight: 700; margin-right: 15px; cursor: pointer; transition: 0.2s; font-size: 1rem; }
.p-btn:hover, .p-btn:focus { background: white; color: black; transform: scale(1.05); }
.p-btn.cta { background: white; color: black; }
.p-btn.red { background: rgba(200,0,0,0.5); } 
.p-btn.red:hover { background: #d00; color: white; }

#pb-ui { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2100; pointer-events: none; flex-direction: column; justify-content: space-between; opacity: 0; transition: 0.3s; }
body.mode-fullscreen #pb-ui { display: flex; }
body.mode-fullscreen #pb-ui.vis { opacity: 1; pointer-events: auto; }
.white-logos .cc-logo, .white-logos .elog, .white-logos .rec-logo { filter: grayscale(100%) brightness(200%) contrast(100%); }
</style>
</head>
<body class="mode-home">
    <video id="bg-vid" autoplay muted loop></video>
    
    <div id="pb-ui">
        <div style="padding:40px; background:linear-gradient(to bottom,rgba(0,0,0,0.9),transparent); display:flex; gap:20px; align-items:center;">
            <div class="nav-item icon" onclick="closePlayer()"><i class="fas fa-arrow-left"></i></div>
            <h1 id="pb-title" style="font-size:2rem; margin:0;">Channel</h1>
        </div>
        <div style="padding:50px; background:linear-gradient(to top,rgba(0,0,0,0.9),transparent); display:flex; gap:20px; align-items:center;">
            <img id="pb-logo" style="height:80px; max-width:150px; object-fit:contain;">
            <span style="background:#c00; padding:5px 12px; border-radius:6px; font-weight:800;">LIVE</span>
        </div>
    </div>

    <div id="pop">
        <div class="p-hero" id="pop-hero"><div class="p-grad"></div></div>
        <div class="p-body">
            <div class="p-post" id="pop-post"></div>
            <div class="p-info">
                <h1 id="pop-title" style="font-size:3.5rem; margin:0 0 15px 0;">Title</h1>
                <p id="pop-desc" style="font-size:1.2rem; color:#bbb; line-height:1.6; max-width:800px;">Description...</p>
                <div id="pop-btns" style="margin-top:30px; display:flex;"></div>
            </div>
        </div>
    </div>

    <div class="info"><span class="clock" id="clk">12:00</span></div>
    <div class="top-nav"><div class="nav-capsule" id="nav"></div></div>

    <div class="main">
        <div id="t-home" class="tab"></div>
        <div id="t-rec" class="tab"></div>
        
        <div id="t-live" class="tab">
            <div class="split">
                <div class="side"><div class="v-menu" id="live-cat"></div></div>
                <div class="linear">
                    <div class="linear-header">
                        <div class="lh-bg" id="lh-bg"></div>
                        <div class="head-con">
                            <div class="lh-box"><img id="lh-img" class="lh-logo-img"></div>
                            <div class="lh-info">
                                <h1 id="lh-title" class="lh-tit">Channel</h1>
                                <div class="lh-meta"><span id="lh-time">--:--</span></div>
                                <p id="lh-desc" class="lh-desc">Info</p>
                            </div>
                            <div class="preview-box-right"><video id="prev-vid" class="preview-video" autoplay muted loop></video></div>
                        </div>
                    </div>
                    <div class="epg-head">
                        <div class="epg-h-l"></div>
                        <div class="epg-h-t" id="epg-h-t"></div>
                    </div>
                    <div class="epg-scroll-area" id="linear-list"></div>
                </div>
            </div>
        </div>

        <div id="t-tv" class="tab"><div class="split"><div class="side"><div class="v-menu" id="tv-cat"></div></div><div class="content-col" id="tv-list"></div></div></div>
        <div id="t-mov" class="tab"><div class="split"><div class="side"><div class="v-menu" id="mov-cat"></div></div><div class="content-col" id="mov-list"></div></div></div>
        <div id="t-yt" class="tab"><div class="split"><div class="side"><div class="v-menu" id="yt-cat"></div></div><div class="content-col" id="yt-list"></div></div></div>
        <div id="t-mus" class="tab"><div class="split"><div class="side"><div class="v-menu" id="mus-cat"></div></div><div class="content-col" id="mus-list"></div></div></div>
        <div id="t-search" class="tab"><div id="s-res"></div></div>
        
        <div id="t-set" class="tab">
            <div class="settings-grid">
                <div class="set-c"><h3>Tabs</h3>
                    Live <label class="sw"><input type="checkbox" id="tg-live" onchange="updSet()"><span class="sl"></span></label><br><br>
                    Recordings <label class="sw"><input type="checkbox" id="tg-rec" onchange="updSet()"><span class="sl"></span></label><br><br>
                    TV <label class="sw"><input type="checkbox" id="tg-tv" onchange="updSet()"><span class="sl"></span></label><br><br>
                    Movies <label class="sw"><input type="checkbox" id="tg-mov" onchange="updSet()"><span class="sl"></span></label><br><br>
                    YouTube <label class="sw"><input type="checkbox" id="tg-yt" onchange="updSet()"><span class="sl"></span></label><br><br>
                    Music <label class="sw"><input type="checkbox" id="tg-mus" onchange="updSet()"><span class="sl"></span></label>
                </div>
                <div class="set-c"><h3>Display</h3>White Logos <label class="sw"><input type="checkbox" id="tg-white" onchange="togWhite()"><span class="sl"></span></label></div>
                <div class="set-c"><h3>Data</h3><button class="btn" style="background:#cc0000;" onclick="clearData()">Clear History</button></div>
            </div>
        </div>
    </div>

<script>
let channels=[], movies=[], series=[], history=[], favs=new Set(), recs=[], lastCh=null;
let currTab='home';
const cats = { live:['All','Favourites','Entertainment','Sports','Movies','News','Extra'], vod:['Browse All','Continue','Watchlist','Action','Comedy'] };

window.onload = () => {
    if(localStorage.getItem('favs')) favs=new Set(JSON.parse(localStorage.getItem('favs')));
    if(localStorage.getItem('hist')) history=JSON.parse(localStorage.getItem('hist'));
    if(localStorage.getItem('recs')) recs=JSON.parse(localStorage.getItem('recs'));
    if(localStorage.getItem('lastCh')) lastCh=JSON.parse(localStorage.getItem('lastCh'));
    
    // Default toggles
    ['live','rec','tv','mov','yt','mus'].forEach(t => { 
        if(!localStorage.getItem('tg-'+t)) localStorage.setItem('tg-'+t,'true');
        const el = document.getElementById('tg-'+t); if(el) el.checked = (localStorage.getItem('tg-'+t)==='true');
    });
    
    if(localStorage.getItem('white')==='true') { document.body.classList.add('white-logos'); document.getElementById('tg-white').checked=true; }
    
    loadMockData();
    switchTab('home');
    setInterval(()=>document.getElementById('clk').innerText=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),1000);
    
    document.addEventListener('keydown', e => {
        if(e.key === 'ArrowRight' && document.activeElement.classList.contains('erow')) scrollEPG(3);
        if(e.key === 'ArrowLeft' && document.activeElement.classList.contains('erow')) scrollEPG(-3);
        if(e.key === 'Escape') {
             if(document.body.classList.contains('mode-fullscreen')) closePlayer();
             else if(document.getElementById('content-page').style.display==='block') document.getElementById('content-page').style.display='none';
             else switchTab('home');
        }
    });
};

function loadMockData() {
    channels = [
        {id:101, name:"BBC One", logo:"https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/BBC_One_logo_2021.svg/1200px-BBC_One_logo_2021.svg.png", cat:"Entertainment"},
        {id:401, name:"Sky Sports Main", logo:"https://upload.wikimedia.org/wikipedia/en/thumb/c/c5/Sky_Sports_Main_Event.svg/1200px-Sky_Sports_Main_Event.svg.png", cat:"Sports"}
    ];
    movies = [{id:'m1', name:"Inception", img:"https://image.tmdb.org/t/p/w500/9gk7admal4ZLcnwnCSALLQU3rjD.jpg", cat:"Action"}];
    series = [{id:'s1', name:"Breaking Bad", img:"https://image.tmdb.org/t/p/w500/ggFHVNu6YYI5L9pCfOacjizRGt.jpg", cat:"Action"}];
    // Default Recs
    if(!recs.length) recs = [{id:'r1', title:"Formula 1", type:'rec', status:'recording', logo:channels[1].logo, img:"https://upload.wikimedia.org/wikipedia/commons/3/33/F1.svg", ch: "Sky Sports F1"}];
}

function isEn(t) { return localStorage.getItem('tg-'+t) !== 'false'; }

function getNav(isRec) {
    if(isRec) return `<div class="n-item icon" onclick="doSearch()"><i class="fas fa-search"></i></div><div class="n-item nav-back" onclick="switchTab('home')"><i class="fas fa-arrow-left"></i></div><div class="n-item act">Recordings</div>`;
    
    let h = `<div class="n-item icon" onclick="doSearch()"><i class="fas fa-search"></i></div><div id="n-home" class="n-item" onclick="switchTab('home')">Home</div>`;
    if(isEn('live')) h+=`<div id="n-live" class="n-item" onclick="switchTab('live')">Live</div>`;
    if(isEn('rec')) h+=`<div id="n-rec" class="n-item" onclick="switchTab('rec')">Recordings</div>`;
    if(isEn('tv')) h+=`<div id="n-tv" class="n-item" onclick="switchTab('tv')">TV Shows</div>`;
    if(isEn('mov')) h+=`<div id="n-mov" class="n-item" onclick="switchTab('mov')">Movies</div>`;
    if(isEn('yt')) h+=`<div id="n-yt" class="n-item" onclick="switchTab('yt')">YouTube</div>`;
    if(isEn('mus')) h+=`<div id="n-mus" class="n-item" onclick="switchTab('mus')">Music</div>`;
    h+=`<div id="n-set" class="n-item" onclick="switchTab('set')">Settings</div>`;
    return h;
}

function switchTab(t) {
    currTab = t;
    const nav = document.getElementById('nav');
    nav.className = `nav-capsule mode-${t}`;
    
    if(t === 'rec') { nav.innerHTML = getNav(true); } 
    else {
        nav.innerHTML = getNav(false);
        if(document.getElementById('n-'+t)) document.getElementById('n-'+t).classList.add('act');
    }
    
    document.querySelector('.main-content').className = `main-content bg-${t}`; // Page BG
    
    document.querySelectorAll('.tab').forEach(e => e.classList.remove('act'));
    let tid = (t==='search') ? 'search' : (t==='rec' ? 'rec' : t);
    document.getElementById('t-'+tid).classList.add('act');
    
    if(t==='home') renderHome();
    if(t==='rec') renderRecs();
    if(t==='live') { renderLive('All'); renderCats('live', cats.live); }
    if(t==='tv') { renderCats('tv', cats.vod); renderVod('tv','All'); }
    if(t==='mov') { renderCats('mov', cats.vod); renderVod('mov','All'); }
    if(t==='search') doSearch();
}

// --- HOME ---
function renderHome() {
    const c = document.getElementById('t-home'); c.innerHTML='';
    const cont = document.createElement('div');
    
    // Slot 1: Last Live
    const rowCW = mkRow('Continue Watching', 'fa-history');
    if(lastLiveChannel) rowCW.scroller.appendChild(mkCard(lastLiveChannel, 'sq', playCh));
    
    // Slot 2: Urgent Reminder (<60m)
    const now = Date.now();
    const urgent = recs.find(r => r.type==='rem' && r.start > now && r.start - now < 3600000);
    if(urgent) rowCW.scroller.appendChild(mkCard(urgent, 'rec', openPop));
    
    // Slot 3+: History Mix
    history.slice(0,10).forEach(h => {
        if(h.type==='ch' && (!lastLiveChannel || h.id!==lastLiveChannel.id)) rowCW.scroller.appendChild(mkCard(h,'sq',playCh));
        if(h.type!=='ch' && isEn(h.type)) rowCW.scroller.appendChild(mkCard(h,'post',openPop));
    });
    if(rowCW.scroller.children.length > 0) cont.appendChild(rowCW.wrap);

    // Watchlist
    const wl = [...movies, ...series].filter(i => favs.has(i.id));
    if(wl.length) { const r = mkRow('Watchlist','fa-list'); wl.forEach(i=>r.scroller.appendChild(mkCard(i,'post',openPop))); cont.appendChild(r.wrap); }

    // Recordings & Reminders
    if(isEn('rec')) {
        const rRow = mkRow('Recordings & Reminders', 'fa-dot-circle');
        recs.forEach(r => {
            const cd = mkCard(r, 'rec', openPop);
            const icon = r.type==='rec' ? '<i class="fas fa-circle" style="color:red"></i>' : '<i class="fas fa-bell"></i>';
            cd.innerHTML += `<div class="rec-type-icon">${icon}</div><img src="${r.logo}" class="rec-logo-overlay">`;
            rRow.scroller.appendChild(cd);
        });
        if(recs.length) cont.appendChild(rRow.wrap);
    }

    // Favourites
    const favCh = channels.filter(c => favs.has(c.id));
    if(favCh.length) { const r = mkRow('Favourite Channels','fa-heart'); favCh.forEach(c=>r.scroller.appendChild(mkCard(c,'sq',playCh))); cont.appendChild(r.wrap); }

    if(isEn('mov')) { const r=mkRow('Top Movies','fa-film'); movies.forEach(m=>r.scroller.appendChild(mkCard(m,'post',openPop))); cont.appendChild(r.wrap); }
    if(isEn('tv')) { const r=mkRow('Recommended TV','fa-tv'); series.forEach(s=>r.scroller.appendChild(mkCard(s,'post',openPop))); cont.appendChild(r.wrap); }

    c.appendChild(cont);
}

// --- EPG (SKY STYLE) ---
function renderLive(cat) {
    const list = document.getElementById('linear-list'); list.innerHTML='';
    const frag = document.createDocumentFragment();
    const now = new Date();
    const min = now.getMinutes();
    
    // Header: -30m to +2.5h
    const tHead = document.getElementById('epg-h-t');
    let th = ''; let startH = now.getHours();
    th += `<div class="time-marker" style="left:100px;">${startH}:30</div>`;
    th += `<div class="time-marker" style="left:300px;">${startH+1}:00</div>`;
    th += `<div class="time-marker" style="left:500px;">${startH+2}:00</div>`;
    tHead.innerHTML = th;

    const items = cat==='All'?channels : channels.filter(c=>c.cat===cat);
    
    items.forEach(c => {
        const row = document.createElement('div'); row.className='erow'; row.tabIndex=0;
        row.onclick = () => openPop(c);
        
        const left = document.createElement('div'); left.className='ecol';
        left.innerHTML = `<div class="enum">${c.id}</div><img class="elog" src="${c.logo}"><div class="ename">${c.name}</div>`;
        
        const line = document.createElement('div'); line.className='etline';
        const tl = document.createElement('div'); tl.className='now-line';
        tl.style.left = `${100 + (min/60)*200}px`;
        line.appendChild(tl);

        const bf = document.createDocumentFragment();
        bf.appendChild(mkBlk("Previous", "100px", {past:true}, c));
        bf.appendChild(mkBlk("Current Program", "200px", {curr:true}, c));
        bf.appendChild(mkBlk("Next Program", "200px", {fut:true}, c));
        bf.appendChild(mkBlk("Later", "200px", {fut:true}, c));
        
        line.appendChild(bf);
        row.append(left, line);
        frag.appendChild(row);
        
        row.onmouseenter = () => {
             document.getElementById('lh-title').innerText = c.name;
             document.getElementById('lh-img').src = c.logo;
             document.getElementById('lh-bg').style.backgroundImage = `url('${c.logo}')`;
        }
    });
    list.appendChild(frag);
}

function mkBlk(t, w, meta, c) {
    const d = document.createElement('div'); d.className='eblock'; d.style.minWidth=w;
    d.innerHTML = `<div class="prog-t">${t}</div><div class="prog-d">Info</div>`;
    d.onclick = (e) => { e.stopPropagation(); openPop({...c, title:t, ...meta}); };
    return d;
}

function scrollEPG(hours) {
    const lists = document.querySelectorAll('.etline');
    lists.forEach(l => l.scrollBy({left: hours*200, behavior:'smooth'}));
}

// --- SEARCH ---
function doSearch(q) {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('act'));
    document.getElementById('t-search').classList.add('act');
    const nav = document.getElementById('nav');
    nav.innerHTML = `<div class="search-box"><div class="n-item icon" onclick="switchTab('${currTab}')"><i class="fas fa-arrow-left"></i></div><input class="search-inp" id="s-inp" placeholder="Search..." autofocus></div>`;
    const inp = document.getElementById('s-inp');
    inp.addEventListener('input', (e) => runSearch(e.target.value));
    setTimeout(()=>inp.focus(), 100);
}

function runSearch(v) {
    const c = document.getElementById('s-res'); c.innerHTML='';
    if(!v) return; v=v.toLowerCase();
    
    let order = ['ch','rec','mov','tv'];
    if(currTab==='rec') order=['rec','ch','mov','tv'];
    if(currTab==='mov') order=['mov','tv','ch','rec'];

    const res = {
        ch: isEn('live') ? channels.filter(x=>x.name.toLowerCase().includes(v)) : [],
        mov: isEn('mov') ? movies.filter(x=>x.name.toLowerCase().includes(v)) : [],
        tv: isEn('tv') ? series.filter(x=>x.name.toLowerCase().includes(v)) : [],
        rec: isEn('rec') ? recs.filter(x=>x.title.toLowerCase().includes(v)) : []
    };
    
    const map = { ch:'Channels', mov:'Movies', tv:'TV Shows', rec:'Recordings & Reminders' };
    const icon = { ch:'fa-tv', mov:'fa-film', tv:'fa-tv', rec:'fa-dot-circle' };
    
    order.forEach(k => {
        if(res[k].length) {
            const r = mkRow(map[k], icon[k]);
            res[k].forEach(i => {
                let type = k==='ch'?'sq':(k==='rec'?'rec':'post');
                let click = k==='ch'?playCh:openPop;
                const cd = mkCard(i, type, click);
                if(k==='rec') {
                     const ico = i.type==='rec'?'<i class="fas fa-circle" style="color:red"></i>':'<i class="fas fa-bell"></i>';
                     cd.innerHTML += `<div class="rec-type-icon">${ico}</div><img src="${i.logo}" class="rec-logo-overlay">`;
                }
                r.scroller.appendChild(cd);
            });
            c.appendChild(r.wrap);
        }
    });
}

// --- UTILS ---
function mkRow(title, icon) {
    const w = document.createElement('div'); w.className='row';
    const h = document.createElement('div'); h.className='row-h'; h.innerHTML=`<i class="fas ${icon}"></i> ${title}`;
    const s = document.createElement('div'); s.className='scroll';
    const d = document.createElement('div'); d.className='row-details'; d.innerHTML=`<h3 class="rd-t"></h3><div class="rd-d"></div>`;
    w.append(h,s,d);
    s.onmouseleave = () => d.classList.remove('vis');
    return {wrap:w, scroller:s, details:d};
}

function mkCard(i, type, clickFn) {
    const d = document.createElement('div'); d.className=`cd c-${type}`; d.tabIndex=0;
    const bg = i.img || i.logo || i.program_image;
    if(type==='sq') d.innerHTML = `<img src="${bg}" style="width:80%; height:80%; object-fit:contain">`;
    else d.style.backgroundImage = `url('${bg}')`;
    
    d.onclick = () => clickFn(i);
    d.onmouseenter = (e) => {
        const det = e.target.parentElement.nextElementSibling;
        if(det) {
            det.querySelector('.rd-t').innerText = i.name || i.title;
            det.querySelector('.rd-d').innerText = i.type === 'rem' ? "Reminder" : (i.cat || "Info...");
            det.classList.add('vis');
        }
    };
    return d;
}

function openPop(i) {
    document.getElementById('content-page').style.display='block';
    document.getElementById('pop-title').innerText = i.name || i.title;
    const bg = i.img || i.logo || i.program_image;
    document.getElementById('pop-hero').style.backgroundImage = `url('${bg}')`;
    
    const post = document.getElementById('pop-post');
    if(!i.cat && !i.program_image) { post.className='p-post sq'; post.innerHTML=`<img src="${bg}">`; post.style.backgroundImage='none'; }
    else { post.className='p-post'; post.innerHTML=''; post.style.backgroundImage=`url('${bg}')`; }

    const b = document.getElementById('pop-btns'); b.innerHTML='';
    
    if(i.type==='rec') b.innerHTML += `<button class="p-btn red" onclick="modRec('${i.id}', false)">Stop Recording</button>`;
    else if(i.type==='remind') b.innerHTML += `<button class="p-btn red" onclick="modRec('${i.id}', false)">Cancel Reminder</button>`;
    else if(!i.cat) {
        b.innerHTML += `<button class="p-btn cta" onclick="playCh(selectedContent)">Watch Live</button>`;
        b.innerHTML += `<button class="p-btn" onclick="addRec()">Record</button>`;
        b.innerHTML += `<button class="p-btn" onclick="addRem()">Remind Me</button>`;
    } else {
        b.innerHTML += `<button class="p-btn cta">Play</button>`;
        b.innerHTML += `<button class="p-btn" onclick="togFav()">Watchlist</button>`;
    }
    
    b.innerHTML += `<button class="p-btn" onclick="doSearch('${i.name||i.title}')">Search</button>`;
    b.innerHTML += `<button class="p-btn" onclick="document.getElementById('content-page').style.display='none'">Back</button>`;
    selectedContent = i;
}

function playCh(i) {
    lastLiveChannel = i; localStorage.setItem('lastLiveChannel', JSON.stringify(i));
    history = history.filter(x=>x.id!==i.id); history.unshift({...i, type:'ch'});
    localStorage.setItem('hist', JSON.stringify(history));
    
    document.getElementById('bg-vid').src = "http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"; 
    document.body.classList.add('mode-fullscreen');
    document.getElementById('pb-ui').classList.add('vis');
    document.getElementById('pb-title').innerText = i.name;
    document.getElementById('pb-logo').src = i.logo;
    document.getElementById('bg-vid').play();
}

function renderRecs() {
    const c = document.getElementById('t-rec'); c.innerHTML='<h1>My Recordings</h1>';
    const rList = recs.filter(r => r.type === 'rec');
    if(rList.length) {
        const r = mkRow('Recorded','fa-dot-circle'); rList.forEach(i=>r.scroller.appendChild(mkCard(i,'rec',openPop)));
        c.appendChild(r.wrap);
    }
}
function renderCats(id, list) {
    const m = document.getElementById(id+'-cat'); m.innerHTML='';
    list.forEach(c => {
        const d=document.createElement('div'); d.className='v-btn'; d.innerText=c;
        d.onclick=()=>loadStreamContent(id, c);
        m.appendChild(d);
    });
}
function renderVod(id, mode) {
    const c = document.getElementById(id+'-list'); c.innerHTML='';
    const src = id==='mov'?movies:series;
    if(mode==='All') { addVODRow(c, "Recommended", src, 'fa-star'); }
}
function addRec() { recs.push({...selectedContent, type:'rec', status:'recording', logo:selectedContent.logo, title:selectedContent.program_title||selectedContent.name}); localStorage.setItem('recs',JSON.stringify(recs)); openPop(recs[recs.length-1]); renderHome(); }
function addRem() { recs.push({...selectedContent, type:'remind', status:'reminder', logo:selectedContent.logo, start:Date.now()+1800000, title:selectedContent.program_title||selectedContent.name}); localStorage.setItem('recs',JSON.stringify(recs)); openPop(recs[recs.length-1]); renderHome(); }
function modRec(id) { recs = recs.filter(r=>r.id!=id && r.id!=selectedContent.id); localStorage.setItem('recs',JSON.stringify(recs)); document.getElementById('content-page').style.display='none'; if(currTab==='home') renderHome(); }
function togFav() { if(favs.has(selectedContent.id)) favs.delete(selectedContent.id); else favs.add(selectedContent.id); localStorage.setItem('favs',JSON.stringify([...favs])); }
function updSet() { ['live','tv','mov','yt','mus'].forEach(t=>localStorage.setItem('tg-'+t, document.getElementById('tg-'+t).checked)); switchTab('home'); }
function togWhite() { document.body.classList.toggle('white-logos'); localStorage.setItem('white', document.body.classList.contains('white-logos')); }
function clearData() { localStorage.clear(); location.reload(); }
function closePlayer() { document.body.classList.remove('mode-fullscreen'); document.getElementById('pb-ui').classList.remove('vis'); document.getElementById('bg-vid').pause(); }
</script>
</body>
</html>
