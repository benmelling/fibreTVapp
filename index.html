<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>StreamTV OS V124</title>
<meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" content="#000000">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<style>
:root { --bg: #000; --surf: rgba(20,20,20,0.95); --rad: 50px; --card: 12px; --gutter: 50px; 
--live: #0047AB; --tv: #D35400; --mov: #27AE60; --yt: #E50914; --mus: #C2185B; --rec: #F1C40F; }
* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body { margin: 0; background: var(--bg); color: #fff; font-family: 'Outfit', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
#bg-vid { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; opacity: 1; filter: blur(30px) brightness(0.4); transition: 0.5s; pointer-events: none; }
body.fs #bg-vid { filter: blur(0); z-index: 0; pointer-events: auto; }
body.fs .top-nav, body.fs .main, body.fs .info { display: none !important; }

/* Navigation */
.top-nav { position: fixed; top: 30px; left: var(--gutter); z-index: 6000; display: flex; }
.nav-cap { background: var(--surf); backdrop-filter: blur(30px); border-radius: var(--rad); padding: 5px; display: flex; gap: 5px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
.n-item { height: 44px; padding: 0 24px; border-radius: var(--rad); color: #888; font-weight: 700; cursor: pointer; display: flex; align-items: center; transition: 0.2s; white-space: nowrap; }
.n-item:hover, .n-item.foc { color: #fff; background: rgba(255,255,255,0.1); }
/* Active Colors */
.nav-cap.live .n-item.act { background: var(--live); color: #fff; }
.nav-cap.tv .n-item.act { background: var(--tv); color: #fff; }
.nav-cap.mov .n-item.act { background: var(--mov); color: #fff; }
.nav-cap.yt .n-item.act { background: var(--yt); color: #fff; }
.nav-cap.mus .n-item.act { background: var(--mus); color: #fff; }
.nav-cap.rec .n-item.act { background: var(--rec); color: #000; }
.n-item.act { background: #fff; color: #000; box-shadow: 0 2px 15px rgba(255,255,255,0.25); }

.n-item.icon { padding: 0; width: 44px; justify-content: center; }
.search-box { display:flex; align-items:center; width:350px; padding-left:10px; }
.search-inp { background:transparent; border:none; color:#fff; font-family:'Outfit'; font-size:1.1rem; flex:1; font-weight: 600; }

.info { position: fixed; top: 30px; right: 40px; background: var(--surf); border-radius: var(--rad); height: 54px; padding: 0 25px; display: flex; align-items: center; z-index: 6000; border: 1px solid rgba(255,255,255,0.1); }
.clock { font-size: 1.1rem; font-weight: 800; }

/* Main Layout */
.main { flex: 1; overflow-y: auto; overflow-x: hidden; padding-top: 130px; padding-bottom: 50px; }
/* Page Specific Backgrounds */
.bg-live { background: linear-gradient(to bottom, rgba(0,0,0,0.5), #001a40) !important; }
.bg-tv { background: linear-gradient(to bottom, rgba(0,0,0,0.5), #401a00) !important; }
.bg-mov { background: linear-gradient(to bottom, rgba(0,0,0,0.5), #00331a) !important; }
.bg-yt { background: linear-gradient(to bottom, rgba(0,0,0,0.5), #400000) !important; }
.bg-mus { background: linear-gradient(to bottom, rgba(0,0,0,0.5), #400033) !important; }

.tab { display: none; padding: 0 var(--gutter) 50px; }
.tab.act { display: block; animation: fade 0.3s; }
@keyframes fade { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
#t-live.act { padding: 0; overflow: hidden; height: 100%; display: flex; }

/* Preview Pane (Top Flush) */
.split { display: flex; height: 100%; }
.side { width: 260px; padding: 120px 0 0 var(--gutter); display: flex; flex-direction: column; }
.v-menu { background: rgba(25,25,25,0.95); border-radius: 25px; padding: 20px; height: calc(100vh - 160px); overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); }
.v-btn { padding: 15px; border-radius: 12px; color: #999; font-weight: 600; cursor: pointer; margin-bottom: 5px; }
.v-btn.act { background: #fff; color: #000; }

.linear { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.preview { 
    height: 40vh; min-height: 300px; background: #000; position: relative; 
    display: flex; align-items: flex-end; justify-content: space-between; 
    padding: 0 40px 30px; margin-top: -130px; /* Counteract main padding to go flush top */
    padding-top: 130px; /* Space for nav */
}
.prev-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; filter: blur(40px) brightness(0.4); z-index: 0; }
.prev-con { position: relative; z-index: 2; width: 100%; display: flex; align-items: center; gap: 30px; }
.lh-box { width: 160px; aspect-ratio: 1/1; background: #111; border-radius: 16px; display: grid; place-items: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
.lh-img { width: 80%; height: 80%; object-fit: contain; }
.lh-info { flex: 1; }
.lh-tit { font-size: 2.5rem; font-weight: 800; line-height: 1.1; margin-bottom: 10px; }
.lh-meta { color: #ccc; font-weight: 700; margin-bottom: 10px; }
.prev-vid { width: 450px; aspect-ratio: 16/9; background: #000; border-radius: 16px; border: 1px solid #333; overflow: hidden; box-shadow: 0 20px 50px #000; }
.prev-vid video { width: 100%; height: 100%; object-fit: cover; }

/* EPG (Sky Style) */
.epg-head { height: 40px; background: #080808; display: flex; border-bottom: 1px solid #222; position: relative; z-index: 10; }
.epg-h-l { width: 380px; flex-shrink: 0; background: #080808; border-right: 1px solid #222; }
.epg-h-t { flex: 1; display: flex; position: relative; overflow: hidden; align-items: center; }
.tm-mk { position: absolute; font-size: 0.8rem; color: #888; border-left: 1px solid #333; padding-left: 8px; height: 20px; line-height: 20px; font-weight: 700; }

.epg-body { flex: 1; overflow-y: auto; background: #050505; }
.erow { display: flex; height: 80px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: background 0.1s; }
.erow:hover, .erow:focus { background: #222; outline: none; }
.ecol { width: 380px; flex-shrink: 0; display: flex; align-items: center; padding: 0 20px; background: #050505; z-index: 5; border-right: 1px solid #222; }
.elog { width: 60px; margin-right: 15px; object-fit: contain; }
.enum { width: 50px; color: #666; font-weight: 800; font-size: 1.2rem; }
.ename { font-weight: 700; font-size: 1.1rem; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.etline { flex: 1; display: flex; align-items: center; overflow-x: auto; position: relative; scrollbar-width: none; }
.eblock { height: 80%; background: rgba(255,255,255,0.1); margin-right: 2px; border-radius: 4px; padding: 0 12px; display: flex; flex-direction: column; justify-content: center; position: relative; flex-shrink: 0; overflow: hidden; }
.eblock:hover { background: rgba(255,255,255,0.25); border-color: white; }
.now-line { position: absolute; top: 0; bottom: 0; width: 2px; background: #5DADE2; z-index: 20; pointer-events: none; box-shadow: 0 0 8px #5DADE2; }

/* Cards & Rows */
.row { margin-bottom: 30px; }
.row-h { font-size: 1.4rem; font-weight: 800; margin: 0 0 15px 0; display: flex; gap: 10px; align-items: center; }
.scroll { display: flex; gap: 20px; overflow-x: auto; padding: 5px 0; scroll-behavior: smooth; }
.scroll::-webkit-scrollbar { display: none; }
.cd { flex: 0 0 auto; background: #222; border-radius: 12px; position: relative; cursor: pointer; transition: 0.2s; overflow: hidden; border: 3px solid transparent; }
.cd:hover, .cd:focus { transform: scale(1.05); border-color: #fff; z-index: 10; }
.c-post { width: 160px; height: 240px; background-size: cover; }
.c-sq { width: 160px; height: 160px; display: flex; align-items: center; justify-content: center; background: #1a1a1a; }
.c-rec { width: 280px; height: 158px; background-size: cover; }
.c-ov { position: absolute; bottom: 0; width: 100%; padding: 15px; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); opacity: 0; }
/* Search hover fix: Hide card title on hover, show below */
.cd:hover .c-ov { opacity: 0; } 
.rec-ico { position: absolute; top: 10px; left: 10px; width: 30px; height: 30px; background: rgba(0,0,0,0.8); border-radius: 50%; display: flex; justify-content: center; align-items: center; }
.rec-ov { position: absolute; bottom: 10px; right: 10px; width: 40px; background: rgba(0,0,0,0.8); border-radius: 4px; padding: 4px; }
.dtl { height: 0; overflow: hidden; transition: 0.2s; opacity: 0; padding-left: 5px; }
.dtl.vis { height: auto; opacity: 1; margin-bottom: 10px; }
.rd-t { font-size: 1.6rem; font-weight: 800; }
.rd-d { font-size: 1.1rem; color: #aaa; margin-top: 5px; }

/* Search Grid */
.s-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; padding: 20px; }

/* Settings */
.set-g { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding-top: 20px; }
.set-c { background: #222; padding: 25px; border-radius: 20px; }
.sw { position: relative; display: inline-block; width: 45px; height: 26px; float: right; }
.sw input { opacity: 0; width: 0; height: 0; }
.sl { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 34px; }
.sl:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .sl { background-color: #fff; }
input:checked + .sl:before { transform: translateX(19px); background-color: #000; }
.btn { width: 100%; padding: 15px; background: var(--live); color: white; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; margin-top: 10px; }

/* Overlays */
#pop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 6000; overflow-y: auto; }
.p-hero { height: 65vh; background-size: cover; position: relative; }
.p-grad { position: absolute; bottom: 0; width: 100%; height: 100%; background: linear-gradient(to top, #000, transparent); }
.p-body { display: flex; gap: 40px; padding: 0 var(--gutter); margin-top: -120px; position: relative; align-items: flex-end; }
.p-post { width: 220px; aspect-ratio: 2/3; background: #222; border-radius: 12px; background-size: cover; box-shadow: 0 20px 60px #000; display: flex; align-items: center; justify-content: center; }
.p-post.sq { aspect-ratio: 1/1; }
.p-info { flex: 1; padding-bottom: 50px; }
.p-btn { background: rgba(255,255,255,0.15); border: none; color: #fff; padding: 15px 30px; border-radius: 10px; font-weight: 700; margin-right: 15px; cursor: pointer; transition: 0.2s; font-size: 1rem; }
.p-btn:hover, .p-btn:focus { background: white; color: black; transform: scale(1.05); }
.p-btn.cta { background: white; color: black; }
.p-btn.red { background: rgba(200,0,0,0.5); }
.p-btn.red:hover { background: #d00; color: white; }

#pb-ui { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2100; pointer-events: none; flex-direction: column; justify-content: space-between; opacity: 0; transition: opacity 0.3s; }
body.mode-fullscreen #pb-ui { display: flex; }
body.mode-fullscreen #pb-ui.vis { opacity: 1; pointer-events: auto; }
.white-logos .cc-logo, .white-logos .elog, .white-logos .rec-logo { filter: grayscale(100%) brightness(200%) contrast(100%); }
</style>
</head>
<body class="mode-home">
    <video id="bg-vid" autoplay muted loop></video>
    
    <div id="pb-ui">
        <div class="pb-top" style="padding:40px; background:linear-gradient(to bottom,rgba(0,0,0,0.9),transparent); display:flex; gap:20px; align-items:center;">
            <div class="nav-item icon" onclick="closePlayer()"><i class="fas fa-arrow-left"></i></div>
            <h1 id="pb-title" style="font-size:2rem; margin:0;">Channel</h1>
        </div>
        <div class="pb-bot" style="padding:50px; background:linear-gradient(to top,rgba(0,0,0,0.9),transparent); display:flex; gap:20px; align-items:center;">
            <img id="pb-logo" style="height:80px; max-width:150px; object-fit:contain;">
            <span style="background:#c00; padding:5px 12px; border-radius:6px; font-weight:800;">LIVE</span>
        </div>
    </div>

    <div id="pop">
        <div class="p-hero" id="pop-hero"><div class="p-grad"></div></div>
        <div class="p-body">
            <div class="p-post" id="pop-post"></div>
            <div class="p-info">
                <h1 id="pop-title" style="font-size:3.5rem; margin:0 0 15px 0;">Title</h1>
                <p id="pop-desc" style="font-size:1.2rem; color:#bbb; line-height:1.6; max-width:800px;">Description...</p>
                <div id="pop-btns" style="margin-top:30px; display:flex;"></div>
            </div>
        </div>
    </div>

    <div class="info"><span class="clock" id="clk">12:00</span></div>
    <div class="top-nav"><div class="nav-capsule" id="nav"></div></div>

    <div class="main">
        <div id="t-home" class="tab"></div>
        <div id="t-rec" class="tab"></div>
        
        <div id="t-live" class="tab">
            <div class="split">
                <div class="side"><div class="v-menu" id="live-cat"></div></div>
                <div class="linear">
                    <div class="linear-header">
                        <div class="lh-bg-blur" id="lh-bg"></div>
                        <div class="header-content">
                            <div class="lh-logo-box"><img id="lh-img" class="lh-logo-img"></div>
                            <div class="header-info-mid">
                                <h1 id="lh-title" class="lh-title">Select Channel</h1>
                                <div class="lh-meta"><span id="lh-time">--:--</span></div>
                                <p id="lh-desc" class="lh-desc">Program Info</p>
                            </div>
                            <div class="preview-box-right"><video id="prev-vid" class="preview-video" autoplay muted loop></video></div>
                        </div>
                    </div>
                    <div class="epg-head">
                        <div class="epg-h-l"></div>
                        <div class="epg-h-t" id="epg-h-t"></div>
                    </div>
                    <div class="epg-scroll-area" id="linear-list"></div>
                </div>
            </div>
        </div>

        <div id="t-tv" class="tab"><div class="split"><div class="side"><div class="v-menu" id="tv-cat"></div></div><div class="content-col" id="tv-list"></div></div></div>
        <div id="t-mov" class="tab"><div class="split"><div class="side"><div class="v-menu" id="mov-cat"></div></div><div class="content-col" id="mov-list"></div></div></div>
        <div id="t-yt" class="tab"><div class="split"><div class="side"><div class="v-menu" id="yt-cat"></div></div><div class="content-col" id="yt-list"></div></div></div>
        <div id="t-mus" class="tab"><div class="split"><div class="side"><div class="v-menu" id="mus-cat"></div></div><div class="content-col" id="mus-list"></div></div></div>
        <div id="t-search" class="tab"><div id="s-res"></div></div>
        
        <div id="t-set" class="tab">
            <div class="set-g">
                <div class="set-c"><h3>Tabs</h3>
                    Live <label class="sw"><input type="checkbox" id="tg-live" onchange="updSet()"><span class="sl"></span></label><br><br>
                    TV <label class="sw"><input type="checkbox" id="tg-tv" onchange="updSet()"><span class="sl"></span></label><br><br>
                    Movies <label class="sw"><input type="checkbox" id="tg-mov" onchange="updSet()"><span class="sl"></span></label><br><br>
                    YouTube <label class="sw"><input type="checkbox" id="tg-yt" onchange="updSet()"><span class="sl"></span></label><br><br>
                    Music <label class="sw"><input type="checkbox" id="tg-mus" onchange="updSet()"><span class="sl"></span></label>
                </div>
                <div class="set-c"><h3>Display</h3>White Logos <label class="sw"><input type="checkbox" id="tg-white" onchange="togWhite()"><span class="sl"></span></label></div>
                <div class="set-c"><h3>Data</h3><button class="btn" style="background:#cc0000;" onclick="clearData()">Clear History</button></div>
            </div>
        </div>
    </div>

<script>
let channels=[], movies=[], series=[], history=[], favs=new Set(), recs=[], lastCh=null;
let currTab = 'home';
const cats = { live:['All','Favourites','Entertainment','Sports','Movies','News','Extra'], vod:['Browse All','Continue','Watchlist','Action','Comedy','Drama'] };

window.onload = () => {
    if(localStorage.getItem('favs')) favs=new Set(JSON.parse(localStorage.getItem('favs')));
    if(localStorage.getItem('hist')) history=JSON.parse(localStorage.getItem('hist'));
    if(localStorage.getItem('recs')) recs=JSON.parse(localStorage.getItem('recs'));
    if(localStorage.getItem('lastCh')) lastCh=JSON.parse(localStorage.getItem('lastCh'));
    
    // Init Toggles
    ['live','tv','mov','yt','mus'].forEach(t => { if(!localStorage.getItem('tg-'+t)) localStorage.setItem('tg-'+t,'true'); });
    
    if(localStorage.getItem('white')==='true') { document.body.classList.add('white-logos'); document.getElementById('tg-white').checked=true; }
    ['live','tv','mov','yt','mus'].forEach(f => document.getElementById('tg-'+f).checked = isEn(f));

    // Mock Data
    channels=[{id:1,name:"BBC One",logo:"https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/BBC_One_logo_2021.svg/1200px-BBC_One_logo_2021.svg.png",cat:"Entertainment"},{id:2,name:"BBC Two",logo:"https://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/BBC_Two_logo_2021.svg/512px-BBC_Two_logo_2021.svg.png",cat:"Entertainment"}];
    movies=[{id:'m1',name:"Inception",img:"https://image.tmdb.org/t/p/w500/9gk7admal4ZLcnwnCSALLQU3rjD.jpg",cat:"Action"}];
    series=[{id:'s1',name:"Breaking Bad",img:"https://image.tmdb.org/t/p/w500/ggFHVNu6YYI5L9pCfOacjizRGt.jpg",cat:"Action"}];

    switchTab('home');
    setInterval(()=>document.getElementById('clk').innerText=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),1000);
    
    // Global Key Listener for EPG Scrolling
    document.addEventListener('keydown', e => {
        if(e.target.classList.contains('epg-row')) {
            const tl = e.target.querySelector('.epg-timeline');
            // Scroll 3 hours (approx 600px)
            if(e.key==='ArrowRight') tl.scrollBy({left:600, behavior:'smooth'});
            if(e.key==='ArrowLeft') tl.scrollBy({left:-600, behavior:'smooth'});
        }
    });
};

function isEn(t) { return localStorage.getItem('tg-'+t) !== 'false'; }

// FIX: Nav Bar Logic
function getNav(isRec) {
    if(isRec) return `<div class="n-item icon" onclick="doSearch()"><i class="fas fa-search"></i></div><div class="n-item nav-back" onclick="switchTab('home')"><i class="fas fa-arrow-left"></i></div><div class="n-item act">Recordings</div>`;
    
    let h = `<div class="n-item icon" onclick="doSearch()"><i class="fas fa-search"></i></div><div id="n-home" class="n-item" onclick="switchTab('home')">Home</div>`;
    if(isEn('live')) h+=`<div id="n-live" class="n-item" onclick="switchTab('live')">Live</div>`;
    h+=`<div id="n-rec" class="n-item" onclick="switchTab('rec')">Recordings</div>`;
    if(isEn('tv')) h+=`<div id="n-tv" class="n-item" onclick="switchTab('tv')">TV Shows</div>`;
    if(isEn('mov')) h+=`<div id="n-mov" class="n-item" onclick="switchTab('mov')">Movies</div>`;
    if(isEn('yt')) h+=`<div id="n-yt" class="n-item" onclick="switchTab('yt')">YouTube</div>`;
    if(isEn('mus')) h+=`<div id="n-mus" class="n-item" onclick="switchTab('mus')">Music</div>`;
    h+=`<div id="n-set" class="n-item" onclick="switchTab('set')">Settings</div>`;
    return h;
}

function switchTab(t) {
    currTab = t;
    const nav = document.getElementById('nav');
    nav.className = `nav-capsule mode-${t}`; // Triggers CSS Colors
    nav.innerHTML = getNav(t==='rec');
    if(t!=='rec' && document.getElementById('n-'+t)) document.getElementById('n-'+t).classList.add('act');
    
    // Backgrounds
    document.querySelector('.main-content').className = `main-content bg-${t}`;
    
    document.querySelectorAll('.tab').forEach(e=>e.classList.remove('act'));
    const tid = (t==='rec'||t==='search') ? 'recordings' : (t==='mov'||t==='tv'?'movies':t); // Map to container IDs
    const el = document.getElementById('t-'+(tid==='recordings'&&t==='rec'?'rec':t)); // Fix Mapping
    if(el) el.classList.add('act');
    else if(t==='rec') document.getElementById('t-rec').classList.add('act'); // Explicit fix for recs
    else document.getElementById('t-'+t).classList.add('act');

    if(t==='home') renderHome();
    if(t==='rec') renderRecs();
    if(t==='live') { renderLive('All'); renderCats('live', cats.live); }
    if(t==='tv') { renderCats('tv', cats.vod); renderVod('tv','All'); }
    if(t==='mov') { renderCats('mov', cats.vod); renderVod('mov','All'); }
    if(t==='search') doSearch();
}

// --- HOME LOGIC ---
function renderHome() {
    const c = document.getElementById('t-home'); c.innerHTML='';
    const cont = document.createElement('div');

    // Continue Watching Logic: 1. Last Live, 2. Urgent Reminder, 3. Mixed History
    const rowCW = mkRow('Continue Watching', 'fa-history');
    
    // Slot 1
    if(lastLiveChannel) rowCW.scroller.appendChild(mkCard(lastLiveChannel,'sq',playCh));
    
    // Slot 2: Urgent Reminder (<60m)
    const now = Date.now();
    const urg = recs.find(r => r.type==='rem' && r.start > now && r.start - now < 3600000);
    if(urg) {
        const cd = mkCard(urg,'rec',openPop);
        cd.innerHTML += `<div class="rec-type-icon" style="background:#c00;"><i class="fas fa-bell"></i></div>`;
        rowCW.scroller.appendChild(cd);
    }
    
    // Slot 3+
    history.slice(0,10).forEach(h => {
         if(h.type==='ch' && (!lastLiveChannel || h.id!==lastLiveChannel.id)) rowCW.scroller.appendChild(mkCard(h,'sq',playCh));
         if(h.type!=='ch' && isEn(h.type)) rowCW.scroller.appendChild(mkCard(h,'post',openPop)); // Check toggle
    });
    if(rowCW.scroller.children.length) cont.appendChild(rowCW.wrap);

    // Watchlist
    const wl = [...movies, ...series].filter(i=>favs.has(i.id));
    if(wl.length) { const r=mkRow('Watchlist','fa-list'); wl.forEach(i=>r.scroller.appendChild(mkCard(i,'post',openPop))); cont.appendChild(r.wrap); }

    // Recordings & Reminders (No Cloud Button)
    const rr = mkRow('Recordings & Reminders', 'fa-dot-circle');
    recs.forEach(r => {
        const cd = mkCard(r,'rec',openPop);
        const ico = r.type==='rec'?'<i class="fas fa-circle" style="color:red"></i>':'<i class="fas fa-bell"></i>';
        cd.innerHTML += `<div class="rec-type-icon">${ico}</div><img src="${r.logo}" class="rec-logo-overlay">`;
        rr.scroller.appendChild(cd);
    });
    if(recs.length) cont.appendChild(rr.wrap);

    // Favourites
    const fv = channels.filter(c=>favs.has(c.id));
    if(fv.length) { const r=mkRow('Favourite Channels','fa-heart'); fv.forEach(c=>r.scroller.appendChild(mkCard(c,'sq',playCh))); cont.appendChild(r.wrap); }

    if(isEn('mov')) { const r=mkRow('Top Movies','fa-film'); movies.forEach(m=>r.scroller.appendChild(mkCard(m,'post',openPop))); cont.appendChild(r.wrap); }
    if(isEn('tv')) { const r=mkRow('Recommended TV','fa-tv'); series.forEach(s=>r.scroller.appendChild(mkCard(s,'post',openPop))); cont.appendChild(r.wrap); }

    c.appendChild(cont);
}

// --- EPG (SKY STYLE) ---
function renderLive(cat) {
    const list = document.getElementById('linear-list'); list.innerHTML='';
    const frag = document.createDocumentFragment();
    const now = new Date();
    const min = now.getMinutes();
    
    // Header Sync: -30m to +2.5h (Total 3h view)
    const th = document.getElementById('epg-h-t');
    let hStr = '';
    let startH = now.getHours();
    // Markers at 0, 1h, 2h positions
    hStr += `<div class="time-marker" style="left:100px;">${startH}:30</div>`; // Approx
    hStr += `<div class="time-marker" style="left:300px;">${startH+1}:00</div>`;
    hStr += `<div class="time-marker" style="left:500px;">${startH+2}:00</div>`;
    th.innerHTML = hStr;

    const items = cat==='All'?channels : channels.filter(c=>c.cat===cat);
    
    items.forEach(c => {
        const row = document.createElement('div'); row.className='erow'; row.tabIndex=0;
        row.onclick = () => openPop(c);
        
        const left = document.createElement('div'); left.className='ecol';
        left.innerHTML = `<div class="epg-num">${c.id}</div><img class="elog" src="${c.logo}"><div class="epg-name">${c.name}</div>`;
        
        const line = document.createElement('div'); line.className='etline';
        
        // Time Line (Light Blue)
        const tl = document.createElement('div'); tl.className='now-line';
        // Logic: 30min = 100px width. Current time is 30m into view (start is -30m)
        // Offset = 100px (past 30m block) + (min/60 * 200px)
        tl.style.left = `${100 + (min/60)*200}px`;
        line.appendChild(tl);

        // Blocks: Previous(30m), Current(1h), Next(1h), Later...
        // Using fragment for blocks
        const bf = document.createDocumentFragment();
        bf.appendChild(mkBlk("Previous", "100px", {past:true}, c));
        bf.appendChild(mkBlk("Current Program", "200px", {curr:true}, c)); // 1 Hour
        bf.appendChild(mkBlk("Next Program", "200px", {fut:true}, c));
        bf.appendChild(mkBlk("Later", "200px", {fut:true}, c));
        
        line.appendChild(bf);
        row.append(left, line);
        frag.appendChild(row);
        
        row.onmouseenter = () => {
             document.getElementById('lh-title').innerText = c.name;
             document.getElementById('lh-img').src = c.logo;
             document.getElementById('lh-bg').style.backgroundImage = `url('${c.logo}')`;
        }
    });
    list.appendChild(frag);
}

function mkBlk(t, w, meta, c) {
    const d = document.createElement('div'); d.className='eblock'; d.style.minWidth=w;
    d.innerHTML = `<div class="prog-t">${t}</div><div class="prog-d">Info</div>`;
    d.onclick = (e) => { e.stopPropagation(); openPop({...c, title:t, ...meta}); };
    return d;
}

// --- SEARCH FIX ---
function doSearch() {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('act'));
    document.getElementById('t-search').classList.add('act');
    const nav = document.getElementById('nav');
    nav.innerHTML = `<div class="search-box"><div class="n-item icon" onclick="switchTab('${currTab}')"><i class="fas fa-arrow-left"></i></div><input class="search-inp" id="s-inp" placeholder="Search..." autofocus></div>`;
    // Fix listener binding
    const inp = document.getElementById('s-inp');
    inp.addEventListener('input', (e) => runSearch(e.target.value));
    setTimeout(()=>inp.focus(), 100);
}

function runSearch(v) {
    const c = document.getElementById('s-res'); c.innerHTML='';
    if(!v) return; v=v.toLowerCase();
    
    // Priority: Recordings 1st if on Rec tab, Movies 1st if on Mov tab, etc.
    let order = ['rec','ch','mov','tv'];
    if(currTab==='mov') order=['mov','tv','ch','rec'];
    if(currTab==='tv') order=['tv','mov','ch','rec'];
    
    const res = {
        ch: isEn('live') ? channels.filter(x=>x.name.toLowerCase().includes(v)) : [],
        mov: isEn('mov') ? movies.filter(x=>x.name.toLowerCase().includes(v)) : [],
        tv: isEn('tv') ? series.filter(x=>x.name.toLowerCase().includes(v)) : [],
        rec: recs.filter(x=>x.title.toLowerCase().includes(v))
    };
    
    const map = { ch:'Channels', mov:'Movies', tv:'TV Shows', rec:'Recordings & Reminders' };
    
    order.forEach(k => {
        if(res[k].length) {
            const r = mkRow(map[k], 'fa-search');
            res[k].forEach(i => {
                let type = k==='ch'?'sq':(k==='rec'?'rec':'post');
                let click = k==='ch'?playCh:openPop; // Channels play, others open pop
                const cd = mkCard(i, type, click);
                if(k==='rec') {
                    const icon = i.type==='rec'?'<i class="fas fa-circle" style="color:red"></i>':'<i class="fas fa-bell"></i>';
                    cd.innerHTML += `<div class="rec-type-icon">${icon}</div><img src="${i.logo}" class="rec-logo-overlay">`;
                }
                r.scroller.appendChild(cd);
            });
            c.appendChild(r.wrap);
        }
    });
}

// --- CORE UTILS ---
function mkRow(t, i) {
    const w = document.createElement('div'); w.className='row';
    const h = document.createElement('div'); h.className='row-h'; h.innerHTML=`<i class="fas ${i}"></i> ${t}`;
    const s = document.createElement('div'); s.className='scroll';
    const d = document.createElement('div'); d.className='row-details'; d.innerHTML=`<h3 class="rd-t"></h3><div class="rd-d"></div>`;
    w.append(h,s,d);
    s.onmouseleave = () => d.classList.remove('vis');
    return {wrap:w, scroller:s, details:d};
}

function mkCard(i, type, clickFn) {
    const d = document.createElement('div'); d.className=`cd c-${type}`; d.tabIndex=0;
    const bg = i.img || i.logo || i.program_image;
    if(type==='sq') d.innerHTML = `<img src="${bg}" style="width:80%; height:80%; object-fit:contain">`;
    else d.style.backgroundImage = `url('${bg}')`;
    
    d.onclick = () => clickFn(i);
    // Hover details below row
    d.onmouseenter = (e) => {
        const det = e.target.parentElement.nextElementSibling;
        if(det) {
            det.querySelector('.rd-t').innerText = i.name || i.title;
            det.querySelector('.rd-d').innerText = i.type === 'rem' ? "Reminder" : (i.cat || "Info...");
            det.classList.add('vis');
        }
    };
    return d;
}

function openPop(i) {
    document.getElementById('content-page').style.display='block';
    document.getElementById('pop-title').innerText = i.name || i.title;
    const bg = i.img || i.logo || i.program_image;
    document.getElementById('pop-hero').style.backgroundImage = `url('${bg}')`;
    
    const post = document.getElementById('pop-post');
    if(!i.cat && !i.program_image) { post.className='p-post sq'; post.innerHTML=`<img src="${bg}">`; post.style.backgroundImage='none'; }
    else { post.className='p-post'; post.innerHTML=''; post.style.backgroundImage=`url('${bg}')`; }

    const b = document.getElementById('pop-btns'); b.innerHTML='';
    
    // Context Buttons
    if(i.type==='rec') b.innerHTML += `<button class="p-btn red" onclick="modRec('${i.id}', true)">Stop Recording</button>`;
    else if(i.type==='rem') b.innerHTML += `<button class="p-btn red" onclick="modRec('${i.id}', true)">Cancel Reminder</button>`;
    else if(i.curr) {
        b.innerHTML += `<button class="p-btn cta" onclick="playCh(selectedContent)">Watch Live</button>`;
        b.innerHTML += `<button class="p-btn" onclick="addRec()">Record</button>`;
    } else if(i.fut) {
        b.innerHTML += `<button class="p-btn" onclick="addRec()">Record</button>`;
        b.innerHTML += `<button class="p-btn" onclick="addRem()">Remind Me</button>`;
    } else { // VOD or Past
        if(i.past) b.innerHTML += `<button class="p-btn">Watch From Start</button>`;
        else b.innerHTML += `<button class="p-btn cta">Play</button>`;
        b.innerHTML += `<button class="p-btn" onclick="togFav()">${favs.has(i.id)?'Remove from':'Add to'} Watchlist</button>`;
    }
    
    b.innerHTML += `<button class="p-btn" onclick="doSearch('${i.name||i.title}')">Search</button>`;
    b.innerHTML += `<button class="p-btn" onclick="document.getElementById('content-page').style.display='none'">Back</button>`;
    selectedContent = i;
}

function playCh(i) {
    lastLiveChannel = i; localStorage.setItem('lastLiveChannel', JSON.stringify(i));
    history = history.filter(x=>x.id!==i.id); history.unshift({...i, type:'ch'});
    localStorage.setItem('hist', JSON.stringify(history));
    
    const v = document.getElementById('bg-vid');
    v.src = "http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"; // Mock
    document.body.classList.add('mode-fullscreen');
    document.getElementById('pb-ui').classList.add('vis');
    document.getElementById('pb-title').innerText = i.name;
    document.getElementById('pb-logo').src = i.logo;
    v.play();
}

function renderRecs() {
    const c = document.getElementById('t-rec'); c.innerHTML='<h1>My Recordings</h1>';
    const rList = recs.filter(r => r.type === 'rec');
    if(rList.length) {
        const r = mkRow('Recorded','fa-dot-circle'); rList.forEach(i=>r.scroller.appendChild(mkCard(i,'rec',openPop)));
        c.appendChild(r.wrap);
    }
}
function renderCats(id, list) {
    const m = document.getElementById(id+'-cat'); m.innerHTML='';
    list.forEach(c => {
        const d=document.createElement('div'); d.className='v-btn'; d.innerText=c;
        d.onclick=()=>loadStreamContent(id, c);
        m.appendChild(d);
    });
}
function renderVod(id, mode) {
    // Basic vod render
    const c = document.getElementById(id+'-list'); c.innerHTML='';
    const src = id==='mov'?movies:series;
    if(mode==='All') { addVODRow(c, "Recommended", src, 'fa-star'); }
}
function addRec() { recs.push({...selectedContent, type:'rec', status:'recording', logo:selectedContent.logo}); localStorage.setItem('recs',JSON.stringify(recs)); openPop(recs[recs.length-1]); }
function addRem() { recs.push({...selectedContent, type:'rem', status:'reminder', logo:selectedContent.logo, start:Date.now()+1800000}); localStorage.setItem('recs',JSON.stringify(recs)); openPop(recs[recs.length-1]); }
function modRec(id) { recs = recs.filter(r=>r.id!=id && r.id!=selectedContent.id); localStorage.setItem('recs',JSON.stringify(recs)); document.getElementById('content-page').style.display='none'; if(currTab==='home') renderHome(); }
function togFav() { 
    if(favs.has(selectedContent.id)) favs.delete(selectedContent.id); else favs.add(selectedContent.id); 
    localStorage.setItem('favs',JSON.stringify([...favs]));
    openPop(selectedContent); // Immediate update
}
function updSet() { ['live','tv','mov','yt','mus'].forEach(t=>localStorage.setItem('tg-'+t, document.getElementById('tg-'+t).checked)); switchTab('home'); }
function togWhite() { document.body.classList.toggle('white-logos'); localStorage.setItem('white', document.body.classList.contains('white-logos')); }
function clearData() { localStorage.clear(); location.reload(); }
function closePlayer() { document.body.classList.remove('mode-fullscreen'); document.getElementById('pb-ui').classList.remove('vis'); document.getElementById('bg-vid').pause(); }
</script>
</body>
</html>
